# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: CI

on:
  pull_request:
    branches:
      - "*"
    types:
      - opened
      - edited
      - synchronize
      - reopened

jobs:
  build-lint-test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    strategy:
      matrix:
        node-version: [20.x, 22.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - name: "â˜ï¸ checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ”§ Use Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: "ğŸ”§ Install pnpm"
        run: npm install -g pnpm

      - name: "ğŸ“¦ Install dependencies"
        run: pnpm -C health-onboarding-form install

      - name: "ğŸ” Lint code"
        run: pnpm -C health-onboarding-form lint

      - name: "ğŸ§ª Run tests"
        if: matrix.node-version != '22.x'
        run: pnpm -C health-onboarding-form test

      - name: "ğŸ§ª Run tests with coverage"
        if: matrix.node-version == '22.x'
        run: |
          pnpm -C health-onboarding-form exec jest --projects jest.client.config.ts jest.server.config.ts --coverage --coverageReporters=text-summary --coverageReporters=lcov --coverageReporters=json-summary

      - name: "ğŸ“Š Add coverage report to workflow summary"
        if: matrix.node-version == '22.x'
        run: |
          node <<'EOF'
          const fs = require("fs");
          const summaryPath = "health-onboarding-form/coverage/coverage-summary.json";
          const summary = JSON.parse(fs.readFileSync(summaryPath, "utf8")).total;

          const formatCoverage = (metric) =>
            `${metric.pct}% (${metric.covered}/${metric.total})`;

          const markdown = [
            "## Test Coverage",
            "| Metric | Coverage |",
            "| --- | --- |",
            `| Lines | ${formatCoverage(summary.lines)} |`,
            `| Statements | ${formatCoverage(summary.statements)} |`,
            `| Functions | ${formatCoverage(summary.functions)} |`,
            `| Branches | ${formatCoverage(summary.branches)} |`,
          ].join("\n");

          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${markdown}\n`);
          EOF

      - name: "ğŸ“¦ Upload coverage artifact"
        if: matrix.node-version == '22.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: health-onboarding-form/coverage
          if-no-files-found: error
